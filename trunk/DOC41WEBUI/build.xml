<?xml version="1.0" encoding="UTF-8"?>
<project name="DOC41-Jenkins" default="build-jenkins">
	
	<tstamp/>

	<property name="secprops.location" value="C:\eclipse\BOEAH\wasproj\doc41webui\conf/security.properties" />
	<property file="${secprops.location}" />
	<property name="ECLIPSE_HOME" value="related/jenkins/eclipse_home" />
	<property name="SLEEP_BETWEEN_SERVERS" value="0"/>
	
	<property name="target" value="1.6"/>
	<property name="source" value="1.6"/>
	<property name="junit.output.dir" value="junit"/>
	<property name="debuglevel" value="source,lines,vars"/>

	<property name="war.name" value="doc41.war" />
	<property name="dir.distrib" value="${basedir}/distrib" />
	<property name="war.file" value="${dir.distrib}/${war.name}" />
	<property name="webapp" value="WebContent" />
	<property name="dir.classes" value="${webapp}/WEB-INF/classes" />
	<property name="dir.libs" value="${webapp}/WEB-INF/lib" />


	<property name="tomcat.dir.tmp" value="/tmp"/>
	<property name="tomcat.script.control" value="sudo /etc/init.d/tomcat-doc41" />
	<property name="tomcat.script.deploy" value="sudo /app/jenkins/scripts/deploy_war.sh" />
	<property name="apache.script.control" value="sudo /app/jenkins/scripts/start_stop_V_Hosts" />
	<property name="server.dev1" value="byymss" />
	<property name="server.dev2" value="" />
	<property name="server.qa1" value="BY09GF" />
	<property name="server.qa2" value="BY09ZR" />
	<property name="server.prod1" value="BY0B5G" />
	<property name="server.prod2" value="BY0B5H" />
	<property name="vhname.dev" value="doc41-dev.bayer-ag.com"/>
	<property name="vhname.qa" value="doc41-qa.bayer-ag.com"/>
	<property name="vhname.prod" value="doc41.bayer-ag.com"/>
	
	<property name="dir.net.share" value="//DE.BAYER.CNB/BBS/BBSGmbH/Group/IBS/IBS-eBC/90 Archive/30 Deployment"/>
	<property name="proj.dir.net.share.qa" value="DOC41/QA"/>
	<property name="proj.dir.net.share.prod" value="DOC41/Prod"/>
	<property name="proj.versionfile" value="cfg/BaseProperties.ini"/>
	<property name="proj.version.regexp.search" value="all\.common\.all\.version=.*"/>
	<property name="proj.version.regexp.replace.prefix" value="all.common.all.version="/>	
	
	<!-- defaults -->
	<property name="apache.failonerror" value="false"/>
	<property name="versionnumber.prefix" value="MANUAL"/>
	<property name="versionnumber.number" value="${DSTAMP}-${TSTAMP}"/>
	<property name="versionnumber" value="${versionnumber.prefix}-${versionnumber.number}"/>

	<taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="related/jenkins/antjars/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef> 

	<path id="path.tomcat">
		<fileset dir="related/jenkins/tomcatjars" includes="*.jar" />
	</path>

	<path id="path.webapp">
		<fileset dir="${dir.libs}" includes="*.jar" />
	</path>

	<path id="path.junit">
		<fileset dir="related/jenkins/junitjars" includes="*.jar" />
	</path>

	<path id="DOC41.classpath">
		<pathelement location="${dir.classes}" />
		<path refid="path.webapp" />
		<path refid="path.tomcat" />
		<path refid="path.junit" />
		<pathelement location="related/serverlibs/sapjco3.jar" />
		<pathelement location="related/serverlibs/ojdbc6.jar" />
		<pathelement location="related/junit/org.springframework.test-3.1.1.RELEASE.jar" />
	</path>
	
	<target name="clean">
        <delete dir="${dir.classes}"/>
    </target>
	
    <target name="init">
        <mkdir dir="${dir.classes}"/>
        <copy includeemptydirs="false" todir="${dir.classes}">
            <fileset dir="src">
                <exclude name="**/*.launch"/>
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
        <copy includeemptydirs="false" todir="${dir.classes}">
            <fileset dir="src-test">
                <exclude name="**/*.launch"/>
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
    </target>
	
    <target name="build" depends="init">
        <echo message="${ant.project.name}: ${ant.file}"/>
        <javac debug="true" debuglevel="${debuglevel}" destdir="${dir.classes}" source="${source}" target="${target}">
            <src path="src"/>
            <classpath refid="DOC41.classpath"/>
        </javac>
    	<replaceregexp
            file="${dir.classes}/${proj.versionfile}"
            match="${proj.version.regexp.search}"
            replace="${proj.version.regexp.replace.prefix}${versionnumber}"
            flags="g"
        />
    </target>
	
    <target name="build-test" depends="init">
        <echo message="${ant.project.name}: ${ant.file}"/>
        <javac debug="true" debuglevel="${debuglevel}" destdir="${dir.classes}" source="${source}" target="${target}">
            <src path="src-test"/>
            <classpath refid="DOC41.classpath"/>
        </javac>
    </target>

	<target name="build-jenkins" description="build in jenkins">
		<antcall target="clean" />
		<antcall target="build" />
		<antcall target="build-test" />
	</target>
	
	<target name="jenkins-deploy-dev" description="build and deploy on dev server from jenkins">
		<antcall target="war"/>
		<antcall target="deploy.to.dev.tomcat"/>
	</target>
	
	<target name="jenkins-deploy-qa" description="build and deploy on qa server from jenkins">
		<antcall target="war"/>
		<antcall target="copy.to.net.share.qa"/>	
		<antcall target="deploy.to.qa.tomcats"/>
	</target>
	
	<target name="jenkins-deploy-prod" description="deploy on prod server from jenkins">
		<antcall target="copy.from.net.share.qa"/>
		<antcall target="copy.to.net.share.prod"/>
		<antcall target="deploy.to.prod.tomcats"/>
	</target>

	<target name="war" description="build war file">
		<antcall target="clean" />
		<antcall target="build" />
		<mkdir dir="${dir.distrib}" />
		<delete file="${war.file}" failonerror="false" />
		<war destfile="${war.file}" webxml="${webapp}/WEB-INF/web.xml" update="true">
			<classes dir="${dir.classes}" />
			<fileset dir="${webapp}">
				<exclude name="WEB-INF/classes/**" />
				<exclude name="WEB-INF/web.xml" />
			</fileset>
		</war>
	</target>
	
	<target name="control.apache.vh">
		<echo message="server = ${server}"/>
		<echo message="virtual.host = ${virtual.host}"/>
		<echo message="command = ${command}"/>
		<echo message="line = ${apache.script.control} ${command}"/>
		<echo message="linux-user = ${linux-user}"/>
		<sshexec host="${server}" username="${linux-user}" password="${linux-password}" trust="true" command="${apache.script.control} ${virtual.host} ${command}"
			failonerror="${apache.failonerror}"/>
	</target>	
	
	<target name="status.apache.vh">
		<sshexec host="${server}" username="${linux-user}" password="${linux-password}" trust="true" command="dir /etc/httpd/vh.d/${virtual.host}*"
					failonerror="${apache.failonerror}"/>
		<sshexec host="${server}" username="${linux-user}" password="${linux-password}" trust="true" command="sudo /etc/init.d/httpd status"
							failonerror="${apache.failonerror}"/>
	</target>
			
	<target name="control.tomcat">
		<echo message="server = ${server}"/>
		<echo message="command = ${command}"/>
		<echo message="line = ${tomcat.script.control} ${command}"/>
		<echo message="linux-user = ${linux-user}"/>
		<sshexec host="${server}" username="${linux-user}" password="${linux-password}" trust="true" command="${tomcat.script.control} ${command}" />
	</target>

	<target name="deploy.to.one.tomcat">
		<!-- copy war file to temp -->
		<scp file="${war.file}" todir="${linux-user}:${linux-password}@${server}:${tomcat.dir.tmp}/${linux-user}" trust="true">
		</scp>
		<!-- stop server -->
		<antcall target="control.apache.vh">
			<param name="server" value="${server}"/>
			<param name="virtual.host" value="${virtual.host}"/>
			<param name="command" value="stop"/>
		</antcall>
		<antcall target="control.tomcat">
			<param name="server" value="${server}"/>
			<param name="command" value="stop"/>
		</antcall>
		<!-- deploy script -->
		<sshexec host="${server}" username="${linux-user}" password="${linux-password}" trust="true" command="${tomcat.script.deploy} ${tomcat.dir.tmp}/${linux-user}/${war.name}" />
		
		<!-- start server -->
		<antcall target="control.tomcat">
			<param name="server" value="${server}"/>
			<param name="command" value="start"/>
		</antcall>
		<antcall target="control.apache.vh">
			<param name="server" value="${server}"/>
			<param name="virtual.host" value="${virtual.host}"/>
			<param name="command" value="start"/>
		</antcall>
	</target>
	

	<target name="deploy.to.dev.tomcat">
		<antcall target="deploy.to.one.tomcat">
			<param name="server" value="${server.dev1}" />
			<param name="virtual.host" value="${vhname.dev}" />
		</antcall>
	</target>

	<target name="deploy.to.qa.tomcats">
		<antcall target="deploy.to.one.tomcat">
			<param name="server" value="${server.qa1}" />
			<param name="virtual.host" value="${vhname.qa}" />
		</antcall>
		<sleep minutes="${SLEEP_BETWEEN_SERVERS}"/>
		<antcall target="deploy.to.one.tomcat">
			<param name="server" value="${server.qa2}" />
			<param name="virtual.host" value="${vhname.qa}" />
		</antcall>
	</target>

	<target name="deploy.to.prod.tomcats">
		<antcall target="deploy.to.one.tomcat">
			<param name="server" value="${server.prod1}" />
			<param name="virtual.host" value="${vhname.prod}" />
		</antcall>
		<sleep minutes="${SLEEP_BETWEEN_SERVERS}"/>
		<antcall target="deploy.to.one.tomcat">
			<param name="server" value="${server.prod2}" />
			<param name="virtual.host" value="${vhname.prod}" />
		</antcall>
	</target>
	
	<target name="servercontrol.start" depends="servercontrol.servernames">
		<antcall target="control.tomcat">
			<param name="server" value="${server1}"/>
			<param name="command" value="start"/>
		</antcall>
		<antcall target="control.apache.vh">
			<param name="server" value="${server1}"/>
			<param name="virtual.host" value="${virtual.host}"/>
			<param name="command" value="start"/>
		</antcall>
		<if>
			<length string="${server2}" when="greater" length="0" />
			<then>
				<antcall target="control.tomcat">
					<param name="server" value="${server2}"/>
					<param name="command" value="start"/>
				</antcall>
				<antcall target="control.apache.vh">
					<param name="server" value="${server2}"/>
					<param name="virtual.host" value="${virtual.host}"/>
					<param name="command" value="start"/>
				</antcall>
			</then>
		</if>
	</target>
	
	<target name="servercontrol.stop" depends="servercontrol.servernames">
		<antcall target="control.apache.vh">
			<param name="server" value="${server1}"/>
			<param name="virtual.host" value="${virtual.host}"/>
			<param name="command" value="stop"/>
		</antcall>
		<antcall target="control.tomcat">
			<param name="server" value="${server1}"/>
			<param name="command" value="stop"/>
		</antcall>
		
		<if>
			<length string="${server2}" when="greater" length="0" />
			<then>
				<antcall target="control.apache.vh">
					<param name="server" value="${server2}"/>
					<param name="virtual.host" value="${virtual.host}"/>
					<param name="command" value="stop"/>
				</antcall>
				<antcall target="control.tomcat">
					<param name="server" value="${server2}"/>
					<param name="command" value="stop"/>
				</antcall>
			</then>
		</if>
	</target>
	
	<target name="servercontrol.restart" depends="servercontrol.servernames">
		<antcall target="control.apache.vh">
			<param name="server" value="${server1}"/>
			<param name="virtual.host" value="${virtual.host}"/>
			<param name="command" value="stop"/>
		</antcall>
		<antcall target="control.tomcat">
			<param name="server" value="${server1}"/>
			<param name="command" value="restart"/>
		</antcall>
		<antcall target="control.apache.vh">
			<param name="server" value="${server1}"/>
			<param name="virtual.host" value="${virtual.host}"/>
			<param name="command" value="start"/>
		</antcall>
		<if>
			<length string="${server2}" when="greater" length="0" />
			<then>
				<sleep minutes="${SLEEP_BETWEEN_SERVERS}"/>
				<antcall target="control.apache.vh">
					<param name="server" value="${server2}"/>
					<param name="virtual.host" value="${virtual.host}"/>
					<param name="command" value="stop"/>
				</antcall>
				<antcall target="control.tomcat">
					<param name="server" value="${server2}"/>
					<param name="command" value="restart"/>
				</antcall>
				<antcall target="control.apache.vh">
					<param name="server" value="${server2}"/>
					<param name="virtual.host" value="${virtual.host}"/>
					<param name="command" value="start"/>
				</antcall>
			</then>
		</if>
	</target>
	
	<target name="servercontrol.status" depends="servercontrol.servernames">
		<antcall target="status.apache.vh">
			<param name="server" value="${server1}"/>
		</antcall>
		<antcall target="control.tomcat">
			<param name="server" value="${server1}"/>
			<param name="command" value="status"/>
		</antcall>
		
		<if>
			<length string="${server2}" when="greater" length="0" />
			<then>
				<antcall target="status.apache.vh">
					<param name="server" value="${server2}"/>
				</antcall>
				<antcall target="control.tomcat">
					<param name="server" value="${server2}"/>
					<param name="command" value="status"/>
				</antcall>
			</then>
		</if>
	</target>
	
	<target name="servercontrol">
		<antcall target="servercontrol.${COMMAND}">
			<param name="STAGE" value="${STAGE}"/>

		</antcall>
	</target>
	
	<target name="servercontrol.servernames">
		<propertycopy name="server1" from="server.${STAGE}1" />
		<propertycopy name="server2" from="server.${STAGE}2" />
		<propertycopy name="virtual.host" from="vhname.${STAGE}" />
	</target>
	
    <target name="copy.to.net.share.qa">
        <mkdir dir="${dir.net.share}/${proj.dir.net.share.qa}/${versionnumber}"/>
        <copy file="${war.file}" todir="${dir.net.share}/${proj.dir.net.share.qa}/${versionnumber}" overwrite="false"/>
    </target>
    
    <target name="copy.from.net.share.qa">
        <delete dir="${dir.distrib}" failonerror="false"/>
        <mkdir dir="${dir.distrib}"/>
        <copy file="${dir.net.share}/${proj.dir.net.share.qa}/${versionnumber}/${war.name}" todir="${dir.distrib}" overwrite="true"/>
    </target>
        
    <target name="copy.to.net.share.prod">
        <mkdir dir="${dir.net.share}/${proj.dir.net.share.prod}/${versionnumber}"/>
        <copy file="${war.file}" todir="${dir.net.share}/${proj.dir.net.share.prod}/${versionnumber}" overwrite="false"/>
    </target>

	<target name="test">
		<echo message="${ECLIPSE_HOME}" />
		<echo message="${versionnumber}"/>
	</target>
	
	<target name="servercontrol.single">
		<propertycopy name="server" from="server.${STAGE}${SERVERNUMBER}" />
		<propertycopy name="virtual.host" from="vhname.${STAGE}" />
		<if>
			<equals arg1="${SERVERTYPE}" arg2="apache-vh"/>
			<then>
				<antcall target="control.apache.vh">
					<param name="server" value="${server}"/>
					<param name="virtual.host" value="${virtual.host}"/>
					<param name="command" value="${COMMAND}"/>
				</antcall>
			</then>
			<elseif>
				<equals arg1="${SERVERTYPE}" arg2="tomcat"/>
				<then>
					<antcall target="control.tomcat">
						<param name="server" value="${server}"/>
						<param name="command" value="${COMMAND}"/>
					</antcall>
				</then>
			</elseif>
		</if>
	</target>
</project>
